<!DOCTYPE html>
<html lang="fr" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Michel Bot â€” Dashboard</title>
    <style>
        :root {
            --bg-primary: #1a1b1e;
            --bg-secondary: #2b2d31;
            --bg-tertiary: #313338;
            --bg-card: #2b2d31;
            --text-primary: #f2f3f5;
            --text-secondary: #b5bac1;
            --text-muted: #949ba4;
            --accent: #5865f2;
            --accent-hover: #4752c4;
            --success: #23a55a;
            --danger: #f23f43;
            --warning: #f0b232;
            --border: #3f4147;
            --shadow: rgba(0,0,0,0.3);
            --radius: 8px;
            --radius-lg: 12px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Segoe UI', 'Helvetica Neue', Arial, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
        }

        /* â”€â”€ Layout â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .app {
            display: flex;
            min-height: 100vh;
        }

        .sidebar {
            width: 260px;
            background: var(--bg-secondary);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            position: fixed;
            top: 0;
            left: 0;
            height: 100vh;
            z-index: 100;
        }

        .sidebar-header {
            padding: 16px 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .sidebar-header h1 {
            font-size: 18px;
            font-weight: 700;
        }

        .sidebar-header .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: var(--success);
            flex-shrink: 0;
        }

        .sidebar-nav {
            flex: 1;
            padding: 8px;
            overflow-y: auto;
        }

        .nav-section {
            margin-bottom: 8px;
        }

        .nav-section-title {
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            color: var(--text-muted);
            padding: 8px 12px 4px;
            letter-spacing: 0.5px;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 12px;
            border-radius: var(--radius);
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.15s;
            font-size: 14px;
        }

        .nav-item:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .nav-item.active {
            background: var(--accent);
            color: white;
        }

        .nav-item .icon {
            font-size: 18px;
            width: 24px;
            text-align: center;
        }

        .sidebar-footer {
            padding: 12px;
            border-top: 1px solid var(--border);
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px;
            border-radius: var(--radius);
        }

        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--accent);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 14px;
            flex-shrink: 0;
        }

        .user-avatar img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
        }

        .user-name {
            font-size: 13px;
            font-weight: 600;
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .logout-btn {
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            font-size: 16px;
            padding: 4px;
        }

        .logout-btn:hover { color: var(--danger); }

        /* â”€â”€ Main Content â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .main {
            flex: 1;
            margin-left: 260px;
            padding: 24px 32px;
            max-width: 1000px;
        }

        .page-header {
            margin-bottom: 24px;
        }

        .page-header h2 {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .page-header p {
            color: var(--text-secondary);
            font-size: 14px;
        }

        /* â”€â”€ Cards â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            padding: 20px;
            margin-bottom: 16px;
        }

        .card-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 16px;
        }

        .card-title {
            font-size: 16px;
            font-weight: 600;
        }

        .card-subtitle {
            font-size: 13px;
            color: var(--text-muted);
            margin-top: 2px;
        }

        /* â”€â”€ Stats Grid â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .stat-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            padding: 20px;
        }

        .stat-label {
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-muted);
            margin-bottom: 8px;
        }

        .stat-value {
            font-size: 28px;
            font-weight: 700;
        }

        .stat-value.online { color: var(--success); }
        .stat-value.error { color: var(--danger); }

        /* â”€â”€ Module List â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .module-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .module-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 14px 16px;
            background: var(--bg-tertiary);
            border-radius: var(--radius);
            cursor: pointer;
            transition: all 0.15s;
        }

        .module-item:hover {
            background: #383a40;
        }

        .module-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .module-name {
            font-size: 14px;
            font-weight: 600;
        }

        .module-status {
            font-size: 12px;
            color: var(--text-muted);
        }

        /* â”€â”€ Toggle Switch â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .toggle {
            position: relative;
            width: 44px;
            height: 24px;
            flex-shrink: 0;
        }

        .toggle input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0; left: 0; right: 0; bottom: 0;
            background: var(--border);
            border-radius: 12px;
            transition: 0.2s;
        }

        .toggle-slider::before {
            content: "";
            position: absolute;
            width: 18px;
            height: 18px;
            left: 3px;
            bottom: 3px;
            background: white;
            border-radius: 50%;
            transition: 0.2s;
        }

        .toggle input:checked + .toggle-slider {
            background: var(--success);
        }

        .toggle input:checked + .toggle-slider::before {
            transform: translateX(20px);
        }

        /* â”€â”€ Config Editor â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .config-editor {
            margin-top: 16px;
        }

        .config-field {
            margin-bottom: 16px;
        }

        .config-field label {
            display: block;
            font-size: 13px;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 6px;
        }

        .config-field input[type="text"],
        .config-field input[type="number"],
        .config-field textarea {
            width: 100%;
            padding: 10px 12px;
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            color: var(--text-primary);
            font-size: 14px;
            font-family: 'Consolas', 'Monaco', monospace;
            outline: none;
            transition: border-color 0.15s;
        }

        .config-field input:focus,
        .config-field textarea:focus {
            border-color: var(--accent);
        }

        .config-field textarea {
            min-height: 120px;
            resize: vertical;
        }

        /* â”€â”€ Buttons â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .btn {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 8px 16px;
            border: none;
            border-radius: var(--radius);
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s;
        }

        .btn-primary {
            background: var(--accent);
            color: white;
        }
        .btn-primary:hover { background: var(--accent-hover); }

        .btn-success {
            background: var(--success);
            color: white;
        }
        .btn-success:hover { opacity: 0.9; }

        .btn-danger {
            background: var(--danger);
            color: white;
        }
        .btn-danger:hover { opacity: 0.9; }

        .btn-ghost {
            background: transparent;
            color: var(--text-secondary);
            border: 1px solid var(--border);
        }
        .btn-ghost:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 13px;
        }

        /* â”€â”€ Toast Notifications â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .toast-container {
            position: fixed;
            bottom: 24px;
            right: 24px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .toast {
            padding: 12px 20px;
            border-radius: var(--radius);
            font-size: 14px;
            font-weight: 500;
            box-shadow: 0 4px 12px var(--shadow);
            animation: toast-in 0.3s ease;
            max-width: 350px;
        }

        .toast.success { background: var(--success); color: white; }
        .toast.error { background: var(--danger); color: white; }
        .toast.info { background: var(--accent); color: white; }

        @keyframes toast-in {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* â”€â”€ Login Page â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .login-page {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            background: var(--bg-primary);
        }

        .login-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            padding: 40px;
            text-align: center;
            max-width: 400px;
            width: 100%;
        }

        .login-card h1 {
            font-size: 28px;
            margin-bottom: 8px;
        }

        .login-card p {
            color: var(--text-secondary);
            margin-bottom: 24px;
        }

        .login-btn {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            padding: 12px 24px;
            background: var(--accent);
            color: white;
            border: none;
            border-radius: var(--radius);
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.15s;
            text-decoration: none;
        }

        .login-btn:hover { background: var(--accent-hover); }

        .login-btn svg { width: 24px; height: 24px; }

        /* â”€â”€ JSON Editor Modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.6);
            z-index: 500;
            align-items: center;
            justify-content: center;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            padding: 24px;
            width: 90%;
            max-width: 700px;
            max-height: 80vh;
            display: flex;
            flex-direction: column;
        }

        .modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 16px;
        }

        .modal-header h3 {
            font-size: 18px;
            font-weight: 700;
        }

        .modal-body {
            flex: 1;
            overflow-y: auto;
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 8px;
            margin-top: 16px;
        }

        .json-editor {
            width: 100%;
            min-height: 300px;
            padding: 12px;
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            color: var(--text-primary);
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 13px;
            resize: vertical;
            outline: none;
            tab-size: 4;
        }

        .json-editor:focus { border-color: var(--accent); }

        .json-error {
            color: var(--danger);
            font-size: 12px;
            margin-top: 6px;
        }

        /* â”€â”€ Server icon â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .server-icon {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--accent);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 14px;
            flex-shrink: 0;
            overflow: hidden;
        }

        .server-icon img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /* â”€â”€ Breadcrumb â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .breadcrumb {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            color: var(--text-muted);
            margin-bottom: 16px;
        }

        .breadcrumb a {
            color: var(--accent);
            text-decoration: none;
            cursor: pointer;
        }

        .breadcrumb a:hover { text-decoration: underline; }

        /* â”€â”€ Loading â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 40px;
            color: var(--text-muted);
        }

        .spinner {
            width: 24px;
            height: 24px;
            border: 3px solid var(--border);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin-right: 12px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* â”€â”€ Responsive â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        @media (max-width: 768px) {
            .sidebar { display: none; }
            .main { margin-left: 0; padding: 16px; }
        }

        /* â”€â”€ Config Key-Value pairs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .kv-grid {
            display: grid;
            grid-template-columns: 200px 1fr;
            gap: 8px 16px;
            align-items: start;
        }

        .kv-key {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-secondary);
            padding-top: 10px;
            word-break: break-all;
        }

        .kv-value input {
            width: 100%;
            padding: 8px 10px;
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            color: var(--text-primary);
            font-size: 13px;
            font-family: 'Consolas', monospace;
            outline: none;
        }

        .kv-value input:focus { border-color: var(--accent); }

        /* â”€â”€ Empty states â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .empty-state {
            text-align: center;
            padding: 40px;
            color: var(--text-muted);
        }

        .empty-state .icon { font-size: 48px; margin-bottom: 12px; }
        .empty-state h3 { margin-bottom: 8px; color: var(--text-secondary); }

        /* â”€â”€ Schema form â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .schema-form {
            display: flex;
            flex-direction: column;
            gap: 16px;
            padding: 4px 0;
        }

        .form-field {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .form-field-header {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .form-label {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-secondary);
        }

        .required-badge {
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
            background: var(--danger);
            color: #fff;
            padding: 1px 5px;
            border-radius: 4px;
        }

        .form-description {
            font-size: 12px;
            color: var(--text-muted);
            margin-bottom: 2px;
        }

        .form-input, .form-textarea {
            width: 100%;
            padding: 8px 10px;
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            color: var(--text-primary);
            font-size: 13px;
            font-family: 'Segoe UI', Arial, sans-serif;
            outline: none;
            transition: border-color 0.15s;
        }

        .form-input:focus, .form-textarea:focus {
            border-color: var(--accent);
        }

        .form-textarea {
            resize: vertical;
            min-height: 60px;
        }

        .form-textarea.json-field {
            font-family: 'Consolas', 'Courier New', monospace;
            font-size: 12px;
        }

        .btn-reveal {
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            cursor: pointer;
            font-size: 16px;
            opacity: 0.6;
            padding: 4px;
        }
        .btn-reveal:hover { opacity: 1; }

        .schema-badge {
            font-size: 11px;
            padding: 2px 8px;
            border-radius: 10px;
            background: var(--accent);
            color: #fff;
            font-weight: 500;
        }
        .schema-badge.no-schema {
            background: var(--bg-tertiary);
            color: var(--text-muted);
        }

        .schema-preview {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .preview-row {
            display: flex;
            justify-content: space-between;
            align-items: baseline;
            padding: 6px 0;
            border-bottom: 1px solid var(--border);
        }
        .preview-row:last-child { border-bottom: none; }

        .preview-label {
            font-size: 13px;
            font-weight: 500;
            color: var(--text-secondary);
            flex-shrink: 0;
            margin-right: 16px;
        }

        .preview-value {
            font-size: 13px;
            color: var(--text-primary);
            text-align: right;
            word-break: break-all;
        }
        .preview-value.empty {
            color: var(--text-muted);
            font-style: italic;
        }
    </style>
</head>
<body>
    <div id="app"></div>
    <div class="toast-container" id="toasts"></div>

    <!-- Editor Modal -->
    <div class="modal-overlay" id="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <h3 id="modal-title">Ã‰diter la configuration</h3>
                <button class="btn btn-ghost btn-sm" onclick="closeModal()">âœ•</button>
            </div>
            <div class="modal-body">
                <textarea class="json-editor" id="json-editor" spellcheck="false"></textarea>
                <div class="json-error" id="json-error"></div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-ghost" onclick="closeModal()">Annuler</button>
                <button class="btn btn-success" id="modal-save-btn" onclick="saveModal()">ğŸ’¾ Sauvegarder</button>
            </div>
        </div>
    </div>

    <script>
    // â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const state = {
        user: null,
        currentPage: 'home',
        currentServerId: null,
        currentModule: null,
        config: null,
        servers: null,
        botInfo: null,
        modules: {},
        moduleSchemas: {},
        globalSchemas: {},
    };

    let modalSaveCallback = null;

    // â”€â”€ API helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function api(url, options = {}) {
        try {
            const resp = await fetch(url, {
                headers: { 'Content-Type': 'application/json', ...options.headers },
                ...options,
            });
            if (resp.status === 401) {
                state.user = null;
                render();
                return null;
            }
            if (!resp.ok) {
                const err = await resp.json().catch(() => ({ detail: 'Erreur inconnue' }));
                throw new Error(err.detail || `HTTP ${resp.status}`);
            }
            return await resp.json();
        } catch (e) {
            toast(e.message, 'error');
            throw e;
        }
    }

    // â”€â”€ Toast system â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function toast(message, type = 'info') {
        const container = document.getElementById('toasts');
        const el = document.createElement('div');
        el.className = `toast ${type}`;
        el.textContent = message;
        container.appendChild(el);
        setTimeout(() => el.remove(), 4000);
    }

    // â”€â”€ Modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function openModal(title, json, onSave) {
        document.getElementById('modal-title').textContent = title;
        document.getElementById('json-editor').value = JSON.stringify(json, null, 4);
        document.getElementById('json-error').textContent = '';
        modalSaveCallback = onSave;
        document.getElementById('modal-overlay').classList.add('active');
    }

    function closeModal() {
        document.getElementById('modal-overlay').classList.remove('active');
        modalSaveCallback = null;
        // Reset modal body to default JSON editor layout
        const body = document.getElementById('modal-overlay').querySelector('.modal-body');
        body.innerHTML = `
            <textarea class="json-editor" id="json-editor" spellcheck="false"></textarea>
            <div class="json-error" id="json-error"></div>
        `;
    }

    async function saveModal() {
        const editor = document.getElementById('json-editor');
        const errorEl = document.getElementById('json-error');

        // Schema form mode: no JSON editor present
        if (!editor) {
            try {
                if (modalSaveCallback) {
                    await modalSaveCallback();
                }
                closeModal();
                toast('Configuration sauvegardÃ©e !', 'success');
            } catch (e) {
                if (errorEl) errorEl.textContent = e.message;
                toast('Erreur lors de la sauvegarde', 'error');
            }
            return;
        }

        // JSON editor mode
        try {
            const parsed = JSON.parse(editor.value);
            if (errorEl) errorEl.textContent = '';
            if (modalSaveCallback) {
                await modalSaveCallback(parsed);
            }
            closeModal();
            toast('Configuration sauvegardÃ©e !', 'success');
        } catch (e) {
            if (e instanceof SyntaxError) {
                if (errorEl) errorEl.textContent = `JSON invalide : ${e.message}`;
            } else {
                if (errorEl) errorEl.textContent = e.message;
                toast('Erreur lors de la sauvegarde', 'error');
            }
        }
    }

    // â”€â”€ Navigation â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function navigate(page, serverId = null, moduleName = null) {
        state.currentPage = page;
        state.currentServerId = serverId;
        state.currentModule = moduleName;
        render();
    }

    // â”€â”€ Data loading â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function loadUserInfo() {
        const data = await api('/api/me');
        if (data && data.authenticated) {
            state.user = data;
        } else {
            state.user = null;
        }
    }

    async function loadBotInfo() {
        try {
            state.botInfo = await api('/api/bot-info');
        } catch (e) {
            state.botInfo = { status: 'error' };
        }
    }

    async function loadServers() {
        try {
            state.servers = await api('/api/servers');
        } catch (e) {
            state.servers = {};
        }
    }

    async function loadModules() {
        try {
            const data = await api('/api/modules');
            state.modules = data.modules || {};
        } catch (e) {
            state.modules = {};
        }
    }

    async function loadSchemas() {
        try {
            const [modSchemas, globalSchemas] = await Promise.all([
                api('/api/schemas/modules'),
                api('/api/schemas/global'),
            ]);
            state.moduleSchemas = modSchemas || {};
            state.globalSchemas = globalSchemas || {};
        } catch (e) {
            state.moduleSchemas = {};
            state.globalSchemas = {};
        }
    }

    async function loadConfig() {
        try {
            state.config = await api('/api/config');
        } catch (e) {
            state.config = {};
        }
    }

    // â”€â”€ Schema-based form rendering â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    /**
     * Render a form based on a schema and current values.
     * @param {string} formId - Unique form ID for collecting values
     * @param {object} schema - { fields: { key: { label, type, description, required, default, secret } } }
     * @param {object} values - Current config values
     * @param {object} options - { excludeEnabled: bool }
     */
    function renderSchemaForm(formId, schema, values, options = {}) {
        const fields = schema.fields || {};
        const entries = Object.entries(fields);
        if (entries.length === 0) return '<p style="color:var(--text-muted)">Aucun champ dÃ©fini.</p>';

        let html = `<div class="schema-form" data-form-id="${formId}">`;
        for (const [key, field] of entries) {
            if (options.excludeEnabled && key === 'enabled') continue;

            const value = values[key];
            const hasValue = value !== undefined && value !== null;
            const fieldType = field.type || 'string';
            const isSecret = field.secret || false;
            const isRequired = field.required || false;

            html += `<div class="form-field" data-key="${key}">`;
            html += `<div class="form-field-header">`;
            html += `<label class="form-label">${field.label || key}`;
            if (isRequired) html += ' <span class="required-badge">requis</span>';
            html += `</label>`;
            html += `</div>`;
            if (field.description) {
                html += `<div class="form-description">${field.description}</div>`;
            }

            switch (fieldType) {
                case 'boolean':
                    html += `
                        <label class="toggle" style="margin-top:4px;">
                            <input type="checkbox" data-field="${key}" data-type="boolean"
                                ${value === true ? 'checked' : ''}>
                            <span class="toggle-slider"></span>
                        </label>`;
                    break;

                case 'number':
                    html += `<input type="number" class="form-input" data-field="${key}" data-type="number"
                        value="${hasValue ? value : (field.default ?? '')}"
                        placeholder="${field.default != null ? 'DÃ©faut: ' + field.default : ''}">`;
                    break;

                case 'secret':
                    html += `<div style="position:relative;">
                        <input type="password" class="form-input" data-field="${key}" data-type="secret"
                            value="${hasValue ? value : ''}"
                            placeholder="${hasValue ? 'â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢' : 'Non dÃ©fini'}">
                        <button class="btn-reveal" onclick="togglePasswordVisibility(this)" type="button" title="Afficher/masquer">ğŸ‘</button>
                    </div>`;
                    break;

                case 'channel':
                case 'role':
                case 'message':
                case 'url':
                    const typeHint = {channel: 'ID du salon', role: 'ID du rÃ´le', message: 'ID du message', url: 'URL'}[fieldType];
                    html += `<input type="text" class="form-input" data-field="${key}" data-type="${fieldType}"
                        value="${hasValue ? escapeHtml(String(value)) : ''}"
                        placeholder="${typeHint}">`;
                    break;

                case 'list':
                    const listVal = Array.isArray(value) ? value.join('\n') : (hasValue ? String(value) : '');
                    const defaultHint = Array.isArray(field.default) ? field.default.join(', ') : '';
                    html += `<textarea class="form-textarea" data-field="${key}" data-type="list"
                        placeholder="${defaultHint ? 'DÃ©faut: ' + defaultHint : 'Une valeur par ligne'}"
                        rows="3">${escapeHtml(listVal)}</textarea>`;
                    break;

                case 'list:number':
                    const numListVal = Array.isArray(value) ? value.join(', ') : (hasValue ? String(value) : '');
                    html += `<input type="text" class="form-input" data-field="${key}" data-type="list:number"
                        value="${escapeHtml(numListVal)}"
                        placeholder="Nombres sÃ©parÃ©s par des virgules (ex: 1, 2, 3)">`;
                    break;

                case 'dict':
                    const jsonStr = hasValue ? JSON.stringify(value, null, 2) : '{}';
                    html += `<textarea class="form-textarea json-field" data-field="${key}" data-type="dict"
                        rows="5" spellcheck="false">${escapeHtml(jsonStr)}</textarea>`;
                    break;

                default: // string
                    html += `<input type="text" class="form-input" data-field="${key}" data-type="string"
                        value="${hasValue ? escapeHtml(String(value)) : ''}"
                        placeholder="${field.default != null ? 'DÃ©faut: ' + field.default : ''}">`;
            }

            html += `</div>`;
        }
        html += `</div>`;
        return html;
    }

    /**
     * Collect form values from a rendered schema form.
     */
    function collectFormValues(formId) {
        const form = document.querySelector(`[data-form-id="${formId}"]`);
        if (!form) return {};
        const result = {};
        const inputs = form.querySelectorAll('[data-field]');
        for (const input of inputs) {
            const key = input.dataset.field;
            const type = input.dataset.type;
            let val;
            switch (type) {
                case 'boolean':
                    val = input.checked;
                    break;
                case 'number':
                    val = input.value === '' ? undefined : Number(input.value);
                    break;
                case 'list':
                    val = input.value.trim() ? input.value.trim().split('\n').map(s => s.trim()).filter(Boolean) : undefined;
                    break;
                case 'list:number':
                    val = input.value.trim()
                        ? input.value.split(',').map(s => Number(s.trim())).filter(n => !isNaN(n))
                        : undefined;
                    break;
                case 'dict':
                    try { val = JSON.parse(input.value); } catch { val = undefined; }
                    break;
                case 'secret':
                    // Only include if user actually typed something
                    val = input.value || undefined;
                    break;
                default:
                    val = input.value || undefined;
            }
            if (val !== undefined) {
                result[key] = val;
            }
        }
        return result;
    }

    function togglePasswordVisibility(btn) {
        const input = btn.previousElementSibling;
        input.type = input.type === 'password' ? 'text' : 'password';
    }

    // â”€â”€ Render â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function render() {
        const app = document.getElementById('app');
        if (!state.user) {
            app.innerHTML = renderLogin();
            return;
        }
        app.innerHTML = `
            <div class="app">
                ${renderSidebar()}
                <div class="main">
                    ${renderPage()}
                </div>
            </div>
        `;
    }

    function renderLogin() {
        return `
            <div class="login-page">
                <div class="login-card">
                    <h1>ğŸ¤– Michel Bot</h1>
                    <p>Connectez-vous avec Discord pour accÃ©der au dashboard de configuration.</p>
                    <a href="/auth/login" class="login-btn">
                        <svg viewBox="0 0 24 24" fill="currentColor">
                            <path d="M20.317 4.37a19.791 19.791 0 0 0-4.885-1.515.074.074 0 0 0-.079.037c-.21.375-.444.864-.608 1.25a18.27 18.27 0 0 0-5.487 0 12.64 12.64 0 0 0-.617-1.25.077.077 0 0 0-.079-.037A19.736 19.736 0 0 0 3.677 4.37a.07.07 0 0 0-.032.027C.533 9.046-.32 13.58.099 18.057a.082.082 0 0 0 .031.057 19.9 19.9 0 0 0 5.993 3.03.078.078 0 0 0 .084-.028c.462-.63.874-1.295 1.226-1.994a.076.076 0 0 0-.041-.106 13.107 13.107 0 0 1-1.872-.892.077.077 0 0 1-.008-.128 10.2 10.2 0 0 0 .372-.292.074.074 0 0 1 .077-.01c3.928 1.793 8.18 1.793 12.062 0a.074.074 0 0 1 .078.01c.12.098.246.198.373.292a.077.077 0 0 1-.006.127 12.299 12.299 0 0 1-1.873.892.077.077 0 0 0-.041.107c.36.698.772 1.362 1.225 1.993a.076.076 0 0 0 .084.028 19.839 19.839 0 0 0 6.002-3.03.077.077 0 0 0 .032-.054c.5-5.177-.838-9.674-3.549-13.66a.061.061 0 0 0-.031-.03z"/>
                        </svg>
                        Se connecter avec Discord
                    </a>
                </div>
            </div>
        `;
    }

    function renderSidebar() {
        const serverItems = state.servers
            ? Object.entries(state.servers).map(([id, s]) => {
                const isActive = (state.currentPage === 'server' || state.currentPage === 'module') && state.currentServerId === id;
                const iconUrl = s.icon
                    ? `https://cdn.discordapp.com/icons/${id}/${s.icon}.png?size=64`
                    : null;
                return `
                    <div class="nav-item ${isActive ? 'active' : ''}" onclick="navigate('server', '${id}')">
                        <div class="server-icon">
                            ${iconUrl ? `<img src="${iconUrl}" alt="">` : s.name?.charAt(0) || '?'}
                        </div>
                        <span>${s.name || id}</span>
                    </div>
                `;
            }).join('')
            : '<div class="loading"><div class="spinner"></div> Chargement...</div>';

        return `
            <div class="sidebar">
                <div class="sidebar-header">
                    <div class="status-dot" style="background: ${state.botInfo?.status === 'online' ? 'var(--success)' : 'var(--warning)'}"></div>
                    <h1>Michel Bot</h1>
                </div>
                <div class="sidebar-nav">
                    <div class="nav-section">
                        <div class="nav-section-title">GÃ©nÃ©ral</div>
                        <div class="nav-item ${state.currentPage === 'home' ? 'active' : ''}" onclick="navigate('home')">
                            <span class="icon">ğŸ </span> Accueil
                        </div>
                        <div class="nav-item ${state.currentPage === 'global' ? 'active' : ''}" onclick="navigate('global')">
                            <span class="icon">âš™ï¸</span> Config globale
                        </div>
                    </div>
                    <div class="nav-section">
                        <div class="nav-section-title">Serveurs</div>
                        ${serverItems}
                    </div>
                </div>
                <div class="sidebar-footer">
                    <div class="user-info">
                        <div class="user-avatar">
                            ${state.user.avatar
                                ? `<img src="https://cdn.discordapp.com/avatars/${state.user.user_id}/${state.user.avatar}.png?size=64" alt="">`
                                : state.user.username.charAt(0)
                            }
                        </div>
                        <span class="user-name">${state.user.username}</span>
                        <button class="logout-btn" onclick="window.location='/auth/logout'" title="DÃ©connexion">ğŸšª</button>
                    </div>
                </div>
            </div>
        `;
    }

    function renderPage() {
        switch (state.currentPage) {
            case 'home': return renderHomePage();
            case 'global': return renderGlobalConfig();
            case 'server': return renderServerPage();
            case 'module': return renderModulePage();
            default: return renderHomePage();
        }
    }

    // â”€â”€ Home Page â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function renderHomePage() {
        const bi = state.botInfo || {};
        const moduleEntries = Object.entries(state.modules);
        return `
            <div class="page-header">
                <h2>Dashboard</h2>
                <p>Vue d'ensemble de Michel Bot</p>
            </div>

            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-label">Statut</div>
                    <div class="stat-value ${bi.status === 'online' ? 'online' : 'error'}">
                        ${bi.status === 'online' ? 'â— En ligne' : bi.status || 'Inconnu'}
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Serveurs</div>
                    <div class="stat-value">${bi.guilds || 0}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Latence</div>
                    <div class="stat-value">${bi.latency != null ? bi.latency + ' ms' : 'â€”'}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Extensions</div>
                    <div class="stat-value">${bi.extensions?.length || 0}</div>
                </div>
            </div>

            ${bi.extensions?.length ? `
                <div class="card">
                    <div class="card-header">
                        <div>
                            <div class="card-title">Extensions chargÃ©es</div>
                            <div class="card-subtitle">${bi.extensions.length} extension(s) active(s)</div>
                        </div>
                        <button class="btn btn-primary btn-sm" onclick="reloadAllExtensions()" id="reload-all-btn">
                            ğŸ”„ Recharger tout
                        </button>
                    </div>
                    <div class="module-list">
                        ${bi.extensions.map(ext => `
                            <div class="module-item">
                                <div class="module-info">
                                    <span class="module-name">ğŸ“¦ ${ext}</span>
                                </div>
                                <button class="btn btn-ghost btn-sm" onclick="event.stopPropagation(); reloadExtension('${ext}')" title="Recharger">
                                    ğŸ”„
                                </button>
                            </div>
                        `).join('')}
                    </div>
                </div>
            ` : ''}

            <div class="card">
                <div class="card-header">
                    <div>
                        <div class="card-title">Modules configurables</div>
                        <div class="card-subtitle">${moduleEntries.length} module(s) dÃ©tectÃ©(s)</div>
                    </div>
                </div>
                <div class="module-list">
                    ${moduleEntries.map(([name, info]) => `
                        <div class="module-item" style="cursor:default">
                            <div class="module-info">
                                <span class="module-name">${info.icon || 'ğŸ§©'} ${info.label || name}</span>
                                <span class="module-status">${info.description || ''}</span>
                            </div>
                            ${info.has_schema ? '<span class="schema-badge">Formulaire</span>' : '<span class="schema-badge no-schema">JSON</span>'}
                        </div>
                    `).join('')}
                </div>
            </div>
        `;
    }

    // â”€â”€ Global Config Page â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function renderGlobalConfig() {
        const globalConfig = state.config?.config || {};
        const allSections = new Set([
            ...Object.keys(globalConfig),
            ...Object.keys(state.globalSchemas),
        ]);
        const sections = [...allSections].sort();

        return `
            <div class="page-header">
                <h2>Configuration globale</h2>
                <p>ParamÃ¨tres partagÃ©s entre tous les serveurs</p>
            </div>

            ${sections.length === 0 ? `
                <div class="empty-state">
                    <div class="icon">ğŸ“­</div>
                    <h3>Aucune configuration</h3>
                    <p>La configuration globale est vide.</p>
                </div>
            ` : sections.map(section => {
                const schema = state.globalSchemas[section];
                const sectionData = globalConfig[section] || {};
                const sectionLabel = schema?.label || section;
                const sectionIcon = schema?.icon || 'ğŸ“';
                const fieldCount = Object.keys(schema?.fields || sectionData).length;

                return `
                    <div class="card">
                        <div class="card-header">
                            <div>
                                <div class="card-title">${sectionIcon} ${sectionLabel}</div>
                                <div class="card-subtitle">${fieldCount} paramÃ¨tre(s)</div>
                            </div>
                            <div style="display:flex;gap:8px;">
                                <button class="btn btn-ghost btn-sm" onclick="editGlobalSectionJson('${section}')">
                                    { } JSON
                                </button>
                                <button class="btn btn-primary btn-sm" onclick="editGlobalSection('${section}')">
                                    âœï¸ Ã‰diter
                                </button>
                            </div>
                        </div>
                        ${schema ? renderSchemaPreview(schema, sectionData) : renderConfigPreview(sectionData)}
                    </div>
                `;
            }).join('')}
        `;
    }

    function renderSchemaPreview(schema, values) {
        const fields = schema.fields || {};
        let html = '<div class="schema-preview">';
        for (const [key, field] of Object.entries(fields)) {
            const val = values[key];
            const hasVal = val !== undefined && val !== null;
            const isSecret = field.secret || false;
            let displayVal = 'â€”';
            if (hasVal) {
                if (isSecret) displayVal = 'â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢';
                else if (typeof val === 'boolean') displayVal = val ? 'âœ… Oui' : 'âŒ Non';
                else if (Array.isArray(val)) displayVal = val.join(', ');
                else if (typeof val === 'object') displayVal = JSON.stringify(val);
                else displayVal = String(val);
            }
            html += `
                <div class="preview-row">
                    <span class="preview-label">${field.label || key}</span>
                    <span class="preview-value ${!hasVal ? 'empty' : ''}">${escapeHtml(displayVal)}</span>
                </div>
            `;
        }
        // Show any extra keys not in schema
        for (const key of Object.keys(values)) {
            if (!(key in fields)) {
                html += `
                    <div class="preview-row">
                        <span class="preview-label" style="color:var(--warning)">${key} <small>(non dÃ©fini dans le schÃ©ma)</small></span>
                        <span class="preview-value">${escapeHtml(JSON.stringify(values[key]))}</span>
                    </div>
                `;
            }
        }
        html += '</div>';
        return html;
    }

    function renderConfigPreview(obj, prefix = '') {
        let html = '<div class="kv-grid">';
        for (const [key, value] of Object.entries(obj)) {
            const fullKey = prefix ? `${prefix}.${key}` : key;
            if (typeof value === 'object' && value !== null && !Array.isArray(value)) {
                html += `<div class="kv-key" style="grid-column: 1 / -1; color: var(--accent); margin-top: 8px;">â–¸ ${key}</div>`;
                html += renderConfigPreview(value, fullKey);
            } else {
                const displayValue = typeof value === 'string' && (key.toLowerCase().includes('token') || key.toLowerCase().includes('secret') || key.toLowerCase().includes('password'))
                    ? 'â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢'
                    : JSON.stringify(value);
                html += `
                    <div class="kv-key">${key}</div>
                    <div class="kv-value"><input type="text" value="${escapeHtml(displayValue)}" readonly></div>
                `;
            }
        }
        html += '</div>';
        return html;
    }

    async function editGlobalSection(section) {
        const globalConfig = state.config?.config || {};
        const sectionData = globalConfig[section] || {};
        const schema = state.globalSchemas[section];

        if (schema) {
            // Show the schema form in a modal
            const formId = `global-${section}`;
            const formHtml = renderSchemaForm(formId, schema, sectionData);
            document.getElementById('modal-title').textContent = `${schema.label || section}`;
            document.getElementById('modal-overlay').querySelector('.modal-body').innerHTML = formHtml;
            const errEl = document.getElementById('json-error');
            if (errEl) errEl.textContent = '';
            modalSaveCallback = async () => {
                const values = collectFormValues(formId);
                // Merge with existing data (to keep keys not in schema)
                const merged = { ...sectionData, ...values };
                await api(`/api/global-config/${section}`, {
                    method: 'PUT',
                    body: JSON.stringify({ section, config: merged }),
                });
                await loadConfig();
                render();
            };
            document.getElementById('modal-overlay').classList.add('active');
        } else {
            editGlobalSectionJson(section);
        }
    }

    async function editGlobalSectionJson(section) {
        const globalConfig = state.config?.config || {};
        const sectionData = globalConfig[section] || {};
        // Reset modal body to JSON editor
        document.getElementById('modal-overlay').querySelector('.modal-body').innerHTML = `
            <textarea class="json-editor" id="json-editor" spellcheck="false"></textarea>
            <div class="json-error" id="json-error"></div>
        `;
        openModal(`Ã‰diter JSON : ${section}`, sectionData, async (newData) => {
            await api(`/api/global-config/${section}`, {
                method: 'PUT',
                body: JSON.stringify({ section, config: newData }),
            });
            await loadConfig();
            render();
        });
    }

    // â”€â”€ Server Page â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function renderServerPage() {
        const sid = state.currentServerId;
        const server = state.servers?.[sid];
        if (!server) {
            return `<div class="loading"><div class="spinner"></div> Chargement...</div>`;
        }
        const serverConfig = server.config || {};
        // Merge all known modules + those already in config
        const allModuleNames = new Set([
            ...Object.keys(serverConfig),
            ...Object.keys(state.moduleSchemas),
        ]);
        const moduleNames = [...allModuleNames].sort();

        const iconUrl = server.icon
            ? `https://cdn.discordapp.com/icons/${sid}/${server.icon}.png?size=128`
            : null;

        return `
            <div class="page-header">
                <div style="display:flex; align-items:center; gap:16px;">
                    <div class="server-icon" style="width:48px;height:48px;font-size:20px;">
                        ${iconUrl ? `<img src="${iconUrl}" alt="">` : server.name?.charAt(0) || '?'}
                    </div>
                    <div>
                        <h2>${server.name || sid}</h2>
                        <p>ID: ${sid} â€” ${Object.keys(serverConfig).length} module(s) configurÃ©(s)</p>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <div class="card-title">Modules</div>
                </div>
                <div class="module-list">
                    ${moduleNames.length === 0 ? `
                        <div class="empty-state">
                            <h3>Aucun module</h3>
                            <p>Ce serveur n'a aucun module configurÃ©.</p>
                        </div>
                    ` : moduleNames.map(mod => {
                        const modConfig = serverConfig[mod] || {};
                        const schema = state.moduleSchemas[mod];
                        const enabled = modConfig.enabled === true;
                        const label = schema?.label || state.modules[mod]?.label || mod;
                        const icon = schema?.icon || state.modules[mod]?.icon || 'ğŸ§©';
                        const desc = schema?.description || '';
                        const isConfigured = mod in serverConfig;
                        return `
                            <div class="module-item" onclick="navigate('module', '${sid}', '${mod}')">
                                <div class="module-info">
                                    <span class="module-name">${icon} ${label}</span>
                                    <span class="module-status">${
                                        isConfigured
                                            ? (enabled ? 'âœ… ActivÃ©' : 'âŒ DÃ©sactivÃ©')
                                            : 'âšª Non configurÃ©'
                                    }</span>
                                </div>
                                <label class="toggle" onclick="event.stopPropagation()">
                                    <input type="checkbox" ${enabled ? 'checked' : ''} 
                                        onchange="toggleModule('${sid}', '${mod}', this.checked)">
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                        `;
                    }).join('')}
                </div>
            </div>
        `;
    }

    async function toggleModule(serverId, moduleName, enabled) {
        try {
            await api(`/api/servers/${serverId}/modules/${moduleName}/toggle`, {
                method: 'POST',
                body: JSON.stringify({ module: moduleName, enabled }),
            });
            toast(`${moduleName} ${enabled ? 'activÃ©' : 'dÃ©sactivÃ©'}`, 'success');
            await loadServers();
            await loadConfig();
            render();
        } catch (e) { /* handled by api() */ }
    }

    // â”€â”€ Module Detail Page â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function renderModulePage() {
        const sid = state.currentServerId;
        const mod = state.currentModule;
        const server = state.servers?.[sid];
        if (!server) return '<div class="loading"><div class="spinner"></div></div>';

        const modConfig = server.config?.[mod] || {};
        const schema = state.moduleSchemas[mod];
        const enabled = modConfig.enabled === true;
        const label = schema?.label || state.modules[mod]?.label || mod;
        const icon = schema?.icon || 'ğŸ§©';
        const description = schema?.description || '';
        const formId = `module-${sid}-${mod}`;

        return `
            <div class="breadcrumb">
                <a onclick="navigate('server', '${sid}')">${server.name || sid}</a>
                <span>â€º</span>
                <span>${icon} ${label}</span>
            </div>

            <div class="page-header">
                <div style="display:flex; align-items:center; justify-content:space-between;">
                    <div>
                        <h2>${icon} ${label}</h2>
                        <p>${description || 'Configuration du module pour ' + (server.name || sid)}</p>
                    </div>
                    <label class="toggle" style="transform: scale(1.2);">
                        <input type="checkbox" ${enabled ? 'checked' : ''} 
                            onchange="toggleModule('${sid}', '${mod}', this.checked)">
                        <span class="toggle-slider"></span>
                    </label>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <div class="card-title">ParamÃ¨tres</div>
                    <div style="display:flex;gap:8px;">
                        <button class="btn btn-ghost btn-sm" onclick="editModuleConfigJson('${sid}', '${mod}')">
                            { } JSON
                        </button>
                        ${schema ? `
                            <button class="btn btn-success" onclick="saveModuleForm('${sid}', '${mod}', '${formId}')">
                                ğŸ’¾ Sauvegarder
                            </button>
                        ` : ''}
                        <button class="btn btn-ghost btn-sm" onclick="saveAndReloadModule('${sid}', '${mod}', '${formId}', ${!!schema})" title="Sauvegarder et recharger l'extension">
                            ğŸ”„ Appliquer
                        </button>
                    </div>
                </div>
                ${schema
                    ? renderSchemaForm(formId, schema, modConfig, { excludeEnabled: true })
                    : (Object.keys(modConfig).length === 0
                        ? `<div class="empty-state">
                            <h3>Configuration vide</h3>
                            <p>Utilisez le bouton "JSON" pour ajouter des paramÃ¨tres.</p>
                        </div>`
                        : renderConfigPreview(modConfig)
                    )
                }
            </div>

            ${schema ? renderExtraKeysCard(schema, modConfig) : ''}
        `;
    }

    function renderExtraKeysCard(schema, config) {
        const schemaKeys = new Set(Object.keys(schema.fields || {}));
        const extraKeys = Object.keys(config).filter(k => !schemaKeys.has(k));
        if (extraKeys.length === 0) return '';
        return `
            <div class="card" style="margin-top:16px;">
                <div class="card-header">
                    <div>
                        <div class="card-title">âš ï¸ ParamÃ¨tres supplÃ©mentaires</div>
                        <div class="card-subtitle">ClÃ©s prÃ©sentes dans la config mais pas dans le schÃ©ma</div>
                    </div>
                </div>
                <div class="kv-grid">
                    ${extraKeys.map(key => `
                        <div class="kv-key" style="color:var(--warning)">${key}</div>
                        <div class="kv-value"><input type="text" value="${escapeHtml(JSON.stringify(config[key]))}" readonly></div>
                    `).join('')}
                </div>
            </div>
        `;
    }

    async function saveModuleForm(serverId, moduleName, formId) {
        try {
            const values = collectFormValues(formId);
            const server = state.servers?.[serverId];
            const existing = server?.config?.[moduleName] || {};
            // Preserve enabled and extra keys
            const merged = { ...existing, ...values };
            await api(`/api/servers/${serverId}/modules/${moduleName}`, {
                method: 'PUT',
                body: JSON.stringify({ config: merged }),
            });
            toast('Configuration sauvegardÃ©e !', 'success');
            await loadServers();
            await loadConfig();
            render();
        } catch (e) { /* handled by api() */ }
    }

    async function saveAndReloadModule(serverId, moduleName, formId, hasSchema) {
        try {
            if (hasSchema) {
                await saveModuleForm(serverId, moduleName, formId);
            }
            // Find the extension that uses this module
            const bi = state.botInfo || {};
            const exts = bi.extensions || [];
            // moduleBirthday -> birthday, moduleTwitch -> twitch, etc.
            const shortName = moduleName.replace(/^module/, '').toLowerCase();
            const matchExt = exts.find(e => e.toLowerCase().includes(shortName));
            if (matchExt) {
                await reloadExtension(matchExt);
            } else {
                toast('Extension non trouvÃ©e â€” rechargez manuellement', 'warning');
            }
        } catch (e) { /* handled */ }
    }

    async function editModuleConfigJson(serverId, moduleName) {
        const server = state.servers?.[serverId];
        const modConfig = server?.config?.[moduleName] || {};
        // Reset modal body to JSON editor
        document.getElementById('modal-overlay').querySelector('.modal-body').innerHTML = `
            <textarea class="json-editor" id="json-editor" spellcheck="false"></textarea>
            <div class="json-error" id="json-error"></div>
        `;
        openModal(`${moduleName} â€” ${server?.name || serverId}`, modConfig, async (newData) => {
            await api(`/api/servers/${serverId}/modules/${moduleName}`, {
                method: 'PUT',
                body: JSON.stringify({ config: newData }),
            });
            await loadServers();
            await loadConfig();
            render();
        });
    }

    // â”€â”€ Reload extensions â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function reloadAllExtensions() {
        const btn = document.getElementById('reload-all-btn');
        if (btn) { btn.disabled = true; btn.textContent = 'â³ Rechargement...'; }
        try {
            const result = await api('/api/reload', { method: 'POST' });
            if (result) {
                const ok = result.reloaded?.length || 0;
                const fail = result.failed?.length || 0;
                if (fail > 0) {
                    toast(`${ok} rechargÃ©e(s), ${fail} en erreur : ${result.failed.map(f => f.name).join(', ')}`, 'error');
                } else {
                    toast(`${ok} extension(s) rechargÃ©e(s) â€” config appliquÃ©e !`, 'success');
                }
            }
        } catch (e) { /* handled by api() */ }
        if (btn) { btn.disabled = false; btn.textContent = 'ğŸ”„ Recharger tout'; }
    }

    async function reloadExtension(extName) {
        try {
            await api(`/api/reload/${extName}`, { method: 'POST' });
            toast(`${extName} rechargÃ©e â€” config appliquÃ©e !`, 'success');
        } catch (e) { /* handled by api() */ }
    }

    // â”€â”€ Utility â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function escapeHtml(str) {
        const div = document.createElement('div');
        div.textContent = String(str);
        return div.innerHTML.replace(/"/g, '&quot;');
    }

    // â”€â”€ Initialize â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function init() {
        await loadUserInfo();
        if (state.user) {
            await Promise.all([loadBotInfo(), loadServers(), loadModules(), loadSchemas(), loadConfig()]);
        }
        render();

        // Periodically refresh bot info
        setInterval(async () => {
            if (state.user) {
                await loadBotInfo();
                if (state.currentPage === 'home') render();
            }
        }, 30000);
    }

    init();
    </script>
</body>
</html>
